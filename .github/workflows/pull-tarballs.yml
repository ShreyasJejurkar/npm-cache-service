name: Pull and Upload Tarballs

on:
  workflow_dispatch:

jobs:
  pull-tarballs-windows:
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Configure npm for better performance
        shell: pwsh
        run:
          |
          npm config set loglevel=warn
          npm config set progress=false
          npm config set fetch-timeout=60000
          npm config set fetch-retry-mintimeout=10000
          npm config set fetch-retry-maxtimeout=120000

      - name: Run pull script (PowerShell)
        shell: pwsh
        run:
          |
          & ./scripts/pull-tarballs.ps1
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Pull tarballs script failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

      - name: Create zip of tarballs
        shell: pwsh
        run:
          |
          if (Test-Path tarballs) {
            $tgzCount = @(Get-ChildItem -Path tarballs -Filter '*.tgz' -ErrorAction SilentlyContinue).Count
            Write-Host "ðŸ“¦ Found $tgzCount .tgz files to compress"
            Compress-Archive -Path tarballs -DestinationPath offline-tarballs.zip -Force
            $zipSize = (Get-Item offline-tarballs.zip).Length / 1MB
            Write-Host "âœ… Created offline-tarballs.zip ($([Math]::Round($zipSize, 2)) MB)"
          } else {
            Write-Error "tarballs directory not found"
            exit 1
          }

      - name: Upload tarballs artifact
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: offline-tarballs
          path: offline-tarballs.zip

      - name: Generate Short Link and Summary
        shell: pwsh
        run:
          |
          # Build nightly.link URL for direct artifact download
          $targetUrl = "https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/offline-tarballs.zip"

          Write-Host "Target URL: $targetUrl"
          try {
              $encodedUrl = [uri]::EscapeDataString($targetUrl)
              $shortUrl = Invoke-RestMethod -Uri "https://is.gd/create.php?format=simple&url=$encodedUrl"
              
              # 1. Output to Job Summary (Markdown on the run homepage)
              "### ðŸš€ Shareable Short Link" >> $env:GITHUB_STEP_SUMMARY
              "The artifact is ready for download:" >> $env:GITHUB_STEP_SUMMARY
              "**$shortUrl**" >> $env:GITHUB_STEP_SUMMARY

              # 2. Add a Workflow Notice (visible in the log header and summary)
              Write-Host "::notice title=Artifact Ready::ðŸš€ Shareable Short Link: $shortUrl"

              # 3. Print to logs with formatting
              Write-Host "`n--------------------------------------------------"
              Write-Host "ðŸš€ Shareable Short Link: $shortUrl"
              Write-Host "--------------------------------------------------`n"
          } catch {
              Write-Warning "Failed to shorten link with is.gd. Please use the original URL: $targetUrl"
          }

          # Add Downloaded Packages List to Summary
          if (Test-Path downloaded-packages.txt) {
            $pkgs = Get-Content downloaded-packages.txt
            $count = $pkgs.Count
            
            "`n### ðŸ“¦ Pulled Packages ($count total)" >> $env:GITHUB_STEP_SUMMARY
            "<details><summary>Click to view all packages and dependencies</summary>`n" >> $env:GITHUB_STEP_SUMMARY
            "| Package Spec |" >> $env:GITHUB_STEP_SUMMARY
            "| :--- |" >> $env:GITHUB_STEP_SUMMARY
            foreach ($pkg in $pkgs) {
              "| ``$pkg`` |" >> $env:GITHUB_STEP_SUMMARY
            }
            "</details>`n" >> $env:GITHUB_STEP_SUMMARY
          }
